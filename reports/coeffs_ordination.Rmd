---
title: "Mapping FS space"
output: github_document
---

```{r setup}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
library(scads)
library(ggplot2)
dataset <- "large"
```

```{r get an SAD}
if(dataset == "plants") {
  
  portal_sad <- portalr::plant_abundance(level = "Treatment", type = "Winter Annuals", plots = "All", unknowns = F, correct_sp = T, shape = "flat", min_quads = 16) %>%
    filter(treatment == "control") %>%
    select(year, species, abundance) %>%
    filter(year == 1994) %>%
    select(-year) %>%
    rename(abund = abundance) %>%
    select(abund) %>%
    arrange(abund) %>%
    as.matrix() %>%
    as.vector()
  
  nleg <- 10
  
} else if(dataset == "rodents94") {
  portal_data <- isds::get_toy_portal_data(download=T, years = c(1994))
  
  portal_sad <- portal_data %>%
    select(species) %>%
    group_by(species) %>%
    summarize(abund = n()) %>%
    ungroup() %>%
    select(abund) %>%
    arrange(abund) %>%
    as.matrix() %>%
    as.vector()
  
  nleg <- 5
  
} else {
  portal_data <- isds::get_toy_portal_data(download=T, years = c(1990:1995))
  
  portal_sad <- portal_data %>%
    select(species) %>%
    group_by(species) %>%
    summarize(abund = n()) %>%
    ungroup() %>%
    select(abund) %>%
    arrange(abund) %>%
    as.matrix() %>%
    as.vector()
  
  nleg <- 8
}

nspp = length(portal_sad)
nind = sum(portal_sad)

portal_sad <- data.frame(
  abund = portal_sad,
  source = "emp",
  rank = 1:length(portal_sad)
)

```

```{r get a BUNCH of fs samples, eval = F, include=T}

fs_bank <- sample_feasibleset(s = nspp, n = nind, nsamples = 10000, distinct = TRUE)
save(fs_bank, file = "fs_bank_94.Rds")

```

```{r load fs bank}

if(dataset == "plants") {
  load(here::here("fs_bank_plants.Rds"))
  nametoprint <- "Portal winter annuals 1994, 10000 draws"
} else if(dataset == "rodents94") {
  load(here::here("fs_bank_94.Rds"))
  nametoprint <- "Portal control rodents 1994, 10000 draws"
} else if(dataset == "small") {
  load(here::here("fs_bank_small.Rds"))
  nametoprint <- "Portal control rodents 1990-95, 100 draws"
} else {
  load(here::here("fs_bank.Rds"))
  nametoprint <- "Portal control rodents 1990=95, 10000 draws"
}

```

```{r manip fs_bank}
fs_bank_M <- fs_bank %>%
  as.data.frame() %>%
  mutate(rank = row_number()) %>%
  tidyr::gather(-rank, key = "sim", value = "abund") %>%
  mutate(sim = as.integer(substr(sim, 2, nchar(sim))))

```


# This report is for `r nametoprint`. 

## Density plots of raw rank abundances

The y-axes are abundance (on the left) and relative abundance (on the right). Each black dot is an abundance value from a vector drawn from the feasible set. The red line plots the distribution from Portal.

The black dots are semi-transparent, which makes it a little easier to see the density distribution.

The rescaled vectors (on the right) are what go into Legendre approximation. In this case, these plots should look identical, because all the draws from the feasible set have the same number of individuals as the Portal vector. I have at other times compared SADs without the total abundance constraint, where the rescaled plots could look quite different.

```{r plot rads and rescaled rads, fig.width = 10}
fs_dp <- ggplot(data = fs_bank_M, aes(x =as.factor(rank), y = abund)) + 
  geom_point(alpha = .2, size = 1) +
  geom_line(data = portal_sad, aes(x = rank, y = abund), alpha = .5, color = "red") +
  theme_bw() +
  ggtitle("Abundance: draws from FS vs Portal")

fs_bank_M <- fs_bank_M %>%
  mutate(sabund = abund / nind)

portal_sad <- portal_sad %>%
  mutate(sabund = abund/nind)

fs_sdp <- ggplot(data = fs_bank_M, aes(x =as.factor(rank), y = sabund)) + 
  geom_point(alpha = .2, size = 1) +
  geom_line(data = portal_sad, aes(x = rank, y = sabund), alpha = .5, color = "red") +
  theme_bw() +
  ggtitle("Abundance: draws from FS vs Portal, rescaled")

gridExtra::grid.arrange(grobs = list(fs_dp, fs_sdp), nrow = 1) 
```


```{r calculations for leg approximation}

fs_leg_coeffs <- apply(as.matrix(1:ncol(fs_bank)), MARGIN = 1, 
                       FUN = function(sim_index, fs_bank_M) 
                         return(legendre_approx(filter(fs_bank_M, sim == sim_index)$sabund, nleg = nleg)$coefficients), fs_bank_M = fs_bank_M)


portal_leg_coeffs <-data.frame(coeff_value = legendre_approx(portal_sad$sabund, nleg = nleg)$coefficients) %>%
  mutate(coeff_name = names(legendre_approx(portal_sad$sabund, nleg = nleg)$coefficients),
         coeff_index = row_number())

fs_leg_coeffs_M <- fs_leg_coeffs %>%
  as.data.frame() %>%
  mutate(coeff_name = row.names(fs_leg_coeffs)) %>%
  tidyr::gather(-coeff_name, key = "sim", value = "coeff_value") %>%
  mutate(sim = as.integer(substr(sim, 2, nchar(sim)))) %>%
  left_join(select(portal_leg_coeffs, coeff_index, coeff_name), by = "coeff_name")


coeffs_plot <- ggplot(data = fs_leg_coeffs_M, aes(x = coeff_index, y = coeff_value)) +
  geom_point(alpha = .2, size = 1) +
  geom_line(data = portal_leg_coeffs, aes(x = coeff_index, y = coeff_value), alpha = .5, color = "red") +
  theme_bw()

```


```{r normality of coeffs}

coeffs_dist <- ggplot(data = fs_leg_coeffs_M, aes(x = coeff_value)) +
  geom_density() +
  facet_wrap(~coeff_name) +
  theme_bw()

coeffs_dist

```

They look quasi-normal?

```{r pca}

coeffs_mat <- fs_leg_coeffs_M %>%
  select(coeff_name, sim, coeff_value) %>%
  tidyr::spread(coeff_name, coeff_value) %>%
  select(-sim) %>%
  as.matrix() 
#$%>%
 #scale()

coeffs_pca <- princomp(coeffs_mat, cor = F, scores = T, fix_sign = T)

summary(coeffs_pca)

biplot(coeffs_pca)

head(coeffs_pca$scores)

coeffs_pca_scores <- data.frame(
  sim = fs_leg_coeffs_M$sim
) %>%
  distinct() %>%
  bind_cols(as.data.frame(coeffs_pca$scores)) %>%
  tidyr::gather(-sim, key = "component", value = "score")


coeffs_pca_plot <- ggplot(data = coeffs_pca_scores, aes(x = score)) +
  geom_density() +
  facet_wrap(~component, scales = "free") +
  theme_bw()

coeffs_pca_plot

coeffs_2comp <- coeffs_pca_scores %>%
  filter(component %in% c("Comp.1", "Comp.2", "Comp.3")) %>%
  tidyr::spread(component, score)

coeffs_2scatterplot <- ggplot(data =coeffs_2comp, aes(x = Comp.1, y = Comp.2, color = Comp.3)) + 
  geom_point() +
  theme_bw() +
  scale_color_viridis_c(end = .8)
coeffs_2scatterplot

```

```{r distance to centroid and skew, fig.width = 12, fig.height = 6}


fs_centroid <- fs_leg_coeffs_M %>%
  group_by(coeff_name) %>%
  summarize(centroid_value = mean(coeff_value)) %>%
  ungroup()

fs_leg_coeffs_M <- fs_leg_coeffs_M %>%
  left_join(fs_centroid, by = "coeff_name")

portal_leg_coeffs <- portal_leg_coeffs %>%
  left_join(fs_centroid, by = "coeff_name")

fs_dist <- fs_leg_coeffs_M %>%
  group_by(sim) %>%
  summarize(centroid_dist = eucl_rows(coeff_value, centroid_value)) %>%
  ungroup() %>%
  arrange(centroid_dist) 

fs_skew <- fs_bank_M %>%
  group_by(sim) %>%
  summarize(skew = conditionalsads::rad_skew(sabund)) %>%
  ungroup()

coeffs_pca_covar <- left_join(coeffs_pca_scores, fs_dist, by = "sim") %>%
  left_join(fs_skew, by = "sim")

p1 <- ggplot(data = coeffs_pca_covar, aes(x =score, y = skew)) +
  geom_point() +
  theme_bw() +
  facet_wrap(~component)

p2 <- ggplot(data = coeffs_pca_covar, aes(x =score, y = centroid_dist)) +
  geom_point() +
  theme_bw() +
  facet_wrap(~component)

gridExtra::grid.arrange(grobs = list(p1, p2), nrow = 1)

```


```{r all the eucl distances}

all_edists <- vector(mode = "numeric", length = max(fs_leg_coeffs_M$sim))

for(i in 1:length(all_edists)) {
  
  this_vect <- filter(fs_leg_coeffs_M, sim == i)$coeff_value
  
  comparisons <- filter(fs_leg_coeffs_M, sim != i) %>%
    group_by(sim) %>%
    summarize(dist_to_v = eucl_rows(coeff_value, this_vect)) %>%
    ungroup()
  
  all_edists[i] = sum(comparisons$dist_to_v)
  
}

all_edists <- data.frame(sim = 1:length(all_edists),
                         sum_dist = all_edists)


coeffs_pca_covar <- left_join(coeffs_pca_scores, fs_dist, by = "sim") %>%
  left_join(fs_skew, by = "sim") %>%
  left_join(all_edists, by = "sim")

p3 <-  ggplot(data = coeffs_pca_covar, aes(x =score, y = sum_dist)) +
  geom_point() +
  theme_bw() +
  facet_wrap(~component)

p3


p4 <-  ggplot(data = coeffs_pca_covar, aes(x =centroid_dist, y = sum_dist)) +
  geom_point() +
  theme_bw() 

p4


p5 <-  ggplot(data = coeffs_pca_covar, aes(x =skew, y = centroid_dist)) +
  geom_point() +
  theme_bw()

p5
```
