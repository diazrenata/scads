---
title: "Exploring S and N space"
output: github_document
date: 10/8/2019
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
#library(drake)
library(dplyr)
library(ggplot2)
library(scads)
```

## Combinations of S & N

These are the combinations of S and N I ran sampling on. There are three chunks: small, large S, and large N. Small is to get at behavior for very small S and N. Large S and large N explore larger communities in those directions. The bottom right corner is gently constrained because N must be >= to S. I tried to explore the general regions of space filled by the datasets in the Baldridge/White papers. I've done this edges-approach because is computationally expensive to explore the large S-large N corner, and there aren't datasets there. 

```{r S and N combos}

small_s <- c(2:10)
small_n <-  c(2:19, seq(20, 200, by = 10))

small_combinations <- expand.grid(S = small_s, N = small_n) %>%
  dplyr::filter(N > S)

combinations_plot <- ggplot(data = small_combinations, aes(x = S, y = N)) +
  geom_point() +
  theme_bw() +
  scale_color_viridis_d(end = .8)

combinations_plot

```


## Number of unique elements (out of 10,000 draws)

I've drawn 10,000 times from the feasible set for each of these S-N combinations. For some of them, we won't be able to get 10,000 unique elements from the feasible set because the FS is in fact much smaller than that. 

```{r unique draws}
di_df <- read.csv(here::here("drake", "di_df.csv"), stringsAsFactors = F)

ndraws <- di_df %>%
  select(S, N, sim) %>%
  distinct() %>%
  group_by(S, N) %>%
  summarize(nsamples = n()) %>%
  ungroup() %>%
  mutate(log_nsamples = log(nsamples)) %>%
  right_join(small_combinations, by = c("S", "N"))

ndraws_plot <- ggplot(data = ndraws, aes(x = S, y = N, color = log_nsamples)) +
  geom_point(alpha = .6) +
  theme_bw() +
  scale_color_viridis_c(end = .8, direction = -1, option = "magma")

ndraws_plot


```

```{r sparse small}

small_df <- small_combinations %>%
  left_join(di_df, by = c("S", "N")) %>%
  select(-X)

sparse_small <- small_df %>%
  filter(N %in% seq(4, 200, by = 4)) %>%
  filter(N %in% c(0:40, 100, 140, 160, 200))

sparse_small_toplot <- sparse_small %>%
  select(S, N) %>%
  distinct()

sparse_small_demoplot <- ggplot(data = sparse_small_toplot, aes(x = S, y = N)) +
  geom_point() +
  theme_bw()

sparse_small_demoplot

```

## Shapes represented - violins

Generally, for the small combinations, it looks like

* the mean value of whatever index increases with increasing S (2:10)
* the lower tail of the index gets longer with increasing N (4:200)
* the tails taper more sharply for Shannon & Simpson than for skewness
* Skewness seems to behave a little counterintuitively. It appears to _increase_ with increasing S; very low S has near-0 skewness. For a given S, the mean skewness decreases with increasing N, and the tail gets longer. Within the scope of strictly increasing RADs, *the larger the skewness, the longer the rare tail in the SAD*. 

```{r shapes math} 

di_df_M <- sparse_small %>%
  tidyr::gather(-sn_combination, -source, -S, -N, -sim, key = "variable", value = "val") %>%
  mutate(nspp = as.factor(S),
         nind = as.factor(N)) %>%
  group_by(S, N, variable) %>%
  mutate(col_val = mean(val, na.rm = T)) %>%
  ungroup() %>%
  group_by(S, N) %>%
  mutate(alpha_val = max(sim) / 10000)

#di_df_M$col_val[ which(is.na(di_df_M$col_val))] <- 0

```

For S=2, skewness is always 0. I have removed those plots.

```{r skew violins, fig.height = 8, fig.width = 8}

skew_violins <- ggplot(data = filter(di_df_M, variable == "skew", S > 2), aes(x = 0, y = val, color = col_val, fill = col_val, alpha = alpha_val)) +
  geom_violin() +
 # geom_point(data = filter(di_df_M, variable == "skew", S == 2)) +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  facet_grid(rows = vars(nind), cols = vars(nspp), switch = "both", scales = "fixed", as.table = F) +
  scale_color_viridis_c(option = "plasma", end = .8) +
   scale_fill_viridis_c(option = "plasma", end = .8) +
  ggtitle("Skew violins")

skew_violins


shannon_violins <- ggplot(data = filter(di_df_M, variable == "shannon"), aes(x = 0, y = val, color = col_val, fill = col_val, alpha = alpha_val)) +
  geom_violin() +
  geom_point(data = filter(di_df_M, variable == "shannon", S == 2)) +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  facet_grid(rows = vars(nind), cols = vars(nspp), switch = "both", scales = "fixed", as.table = F) +
  scale_color_viridis_c(option = "plasma", end = .8) +
   scale_fill_viridis_c(option = "plasma", end = .8)  +
  ggtitle("Shannon violins")

shannon_violins

simpson_violins <- ggplot(data = filter(di_df_M, variable == "simpson"), aes(x = 0, y = val, color = col_val, fill = col_val, alpha = alpha_val)) +
  geom_violin() +
  geom_point(data = filter(di_df_M, variable == "simpson", S == 2)) +
  theme_bw() +
  theme(panel.grid = element_blank() ) +
  facet_grid(rows = vars(nind), cols = vars(nspp), switch = "both", scales = "fixed", as.table = F) +
  scale_color_viridis_c(option = "plasma", end = .8) +
   scale_fill_viridis_c(option = "plasma", end = .8)  +
  ggtitle("Simpson violins")

simpson_violins

```

## Multipanel heatmaps

```{r handle fs_df}

fs_df <- read.csv(here::here("drake", "fs_df_first1000.csv"), stringsAsFactors = F)

fs_df <- fs_df %>%
  right_join(sparse_small, by = c("sim", "S", "N", "source"))

fs_df_M <- fs_df %>%
  select(-sn_combination.x, -sn_combination.y) %>%
  filter(sim <= 1000) %>%
  group_by(S, N) %>%
  mutate(alphaval = 1/max(sim)) %>%
  ungroup() %>%
  mutate(nind = as.factor(N),
         nspp = as.factor(S))

```

```{r heatmaps}


simp_heatmap <- ggplot(data = fs_df_M, aes(x = rank, y = abund, color = simpson, group = sim, alpha = alphaval)) +
  geom_line(size = .1) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = "none") +
  facet_grid(rows = vars(nind), cols = vars(nspp), switch = "both", scales = "free", as.table = F) +
  scale_color_viridis_c(option = "plasma", end = .8) +
  ggtitle("Simpson heatmap")

simp_heatmap


shannon_heatmap <- ggplot(data = fs_df_M, aes(x = rank, y = abund, color = shannon, group = sim, alpha = alphaval)) +
  geom_line(size = .1) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = "none") +
  facet_grid(rows = vars(nind), cols = vars(nspp), switch = "both", scales = "free", as.table = F) +
  scale_color_viridis_c(option = "plasma", end = .8) +
  ggtitle("Shannon heatmap")

shannon_heatmap


skew_heatmap <- ggplot(data = fs_df_M, aes(x = rank, y = abund, color = skew, group = sim, alpha = alphaval)) +
  geom_line(size = .1) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = "none") +
  facet_grid(rows = vars(nind), cols = vars(nspp), switch = "both", scales = "free", as.table = F) +
  scale_color_viridis_c(option = "plasma", end = .8) +
  ggtitle("Skew heatmap")

skew_heatmap

```