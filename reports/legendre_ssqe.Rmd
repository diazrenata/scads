---
title: "fit_legendre"
author: "Renata Diaz"
date: "8/19/2019"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r legendre raw}
library(ggplot2)
library(meteR)
library(dplyr)
library(scads)
```


```{r get some data, eval = F, echo =F}

portal_data <- isds::get_toy_portal_data(download=T)

portal_sad <- portal_data %>%
  select(species) %>%
  group_by(species) %>%
  summarize(abund = n()) %>%
  ungroup() %>%
  select(abund) %>%
  arrange(abund) %>%
  as.matrix() %>%
  as.vector()

nspp = length(portal_sad)
nind = sum(portal_sad)
nsamples = 10

set.seed(1977)

mete_samples <- sample_METE(s = nspp, n = nind, nsamples = nsamples, distinct = TRUE) %>%
  tidyr::gather(key = "sim", value = "abund") %>%
  dplyr::mutate(sim = as.integer(substr(sim, 2, nchar(sim))),
                source = "mete")

fs_samples <- sample_feasibleset(s = nspp, n = nind, nsamples = nsamples, distinct = TRUE) %>%
  tidyr::gather(key = "sim", value = "abund") %>%
  dplyr::mutate(sim = as.integer(substr(sim, 2, nchar(sim))),
                source = "fs")

portal_sad <- data.frame(
  sim = as.integer(-99),
  abund = portal_sad,
  source = "emp"
)

all_sads <- dplyr::bind_rows(portal_sad, mete_samples, fs_samples)

all_sads_fit <- all_sads %>%
  dplyr::group_by(source, sim) %>%
  dplyr::summarize(ssqe_leg2 = sum((legendre_approx(abund, nleg = 2)$residuals) ^ 2),
                   ssqe_leg3= sum((legendre_approx(abund, nleg = 3)$residuals) ^ 2),
                   ssqe_leg6 = sum((legendre_approx(abund, nleg = 6)$residuals) ^ 2),
                   ssqe_emp = ssqe(a = abund, b = filter(all_sads, source == "emp")$abund),
                   ssqe_fs = ssqe(a = abund, b = sample_feasibleset(s = nspp,
                                                                    n = nind,
                                                                    nsamples = 1)$V1),
                   ssqe_mete = ssqe(a = abund, b= sample_METE(s = nspp,
                                                              n=nind,
                                                              nsamples = 1)$V1)) %>%
  dplyr::ungroup() %>%
  tidyr::gather(-sim, -source, key = "ssqe_source", value = "ssqe") %>%
  dplyr::mutate(ssqe_source = substr(ssqe_source, 6, nchar(ssqe_source)))

n_ssqes <- length(unique(all_sads_fit$ssqe_source))

save.image(file = here::here("reports", "legendre_stash", "stash.RData"))


```

````{r or load stuff, echo = F}
load(here::here("reports", "legendre_stash", "stash.RData"))
```

```{r plot ssqes, fig.height= 3 * (n_ssqes / 2), fig.width = 10, echo =F}

if(!exists('nsamples')) {
  nsamples <- 10
}

ssqe_plot1 <- ggplot(data = dplyr::filter(all_sads_fit, source != "emp", ssqe_source %in% c("leg2", "leg3", "leg6")), aes(x = ssqe)) +
  geom_histogram() +
  xlim(-0.1, .99) +
  ylim(0, nsamples) +
  facet_grid(rows = vars(ssqe_source), cols = vars(source), drop = FALSE, switch = "both") +
  theme_bw()

ssqe_plot2 <-  ggplot(data = dplyr::filter(all_sads_fit, source != "emp", ssqe_source %in% c("emp", "mete", "fs")), aes(x = ssqe)) +
geom_histogram() +
  xlim(-0.1, .99) +
  ylim(0, nsamples) +
  facet_grid(rows = vars(ssqe_source), cols = vars(source), drop = TRUE, switch = "both") +
  theme_bw()

emp_ssq_plot <- ggplot(data = dplyr::filter(all_sads_fit, source == "emp", ssqe_source %in% c("leg2", "leg3", "leg6")), aes(x = ssqe_source, y = ssqe)) +
  geom_point() +
  theme_bw()

gridExtra::grid.arrange(grobs = list(ssqe_plot1, ssqe_plot2), nrow = 1)

```

```{r emp plot, echo = F}
emp_ssq_plot
```
